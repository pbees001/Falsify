"use strict";!function(){window.PianoESP.registerWidget("_rec_onsite_embedded",function(e,t,i){function n(t,i){e.call(this,t,i),this.config.visitStarted=i.started,this.rec_onsite_embedded=!0,r(document.head).append('<link rel="dns-prefetch" href="//go.publisher-news.com" />')}var r=i.$();return t(n,e),n.prototype.getMyName=function(){return"Onsite Recommendation Embedded "+e.prototype.getMyName.apply(this,arguments)},n.prototype.__canDisplayOnOutAfterClose=function(){return!1},n.prototype.__click=function(e){this.__$events.emit("click",e);var t=this.__getRecId(e),i=this.__restoreRecommendations();if(r.isArray(i)&&i.length){var n=r.grep(i,function(e){return e.link!==t});this.__storeRecommendations(n)}},n.prototype.__closeForm=function(){var e=this;setTimeout(function(){e.animationFinished()},0)},n.prototype.__genFormUrl=function(){return i.API_HOST+"/publisher/bekose/"+this.config.id+"?wv="+this.config.version},n.prototype.__getFormPlacement=function(){var e=this.config.behavior.placeholder_name,t=r('pnespwgtplaceholder[holdername="'+e+'"]');if(!t.length)return i.loge(this.__me()+"::__getFormPlacement",this.config.id,"placeholder is not found. Placeholder:",e),null;var n=r("<pnespwidget />");return i.copyAttributes(t,n),t.replaceWith(n),n},n.prototype.__getFormStyles=function(){return{form:{width:this.config.view.recommendation.responsive?"100%":this.config.view.width,"max-width":this.config.view.width+"px",display:"block",overflow:"hidden",height:0,opacity:0},iframe:{border:"none",width:"100%",height:0}}},n.prototype.__getIframeResizerArgs=function(){return{interval:-1e3}},n.prototype.__getRecId=function(e){return String(e&&e.url).split("?")[0].replace(/^https?:/i,"")},n.prototype.getRecommendations=function(e){var t,n,o=this;return i.try(function(){var s=o.__restoreRecommendations();return n=o.config.recommendations.display_size,s&&r.isArray(s)&&s.length>=n?[s,i.restore(o.config.id+"-recs-ls")||0]:(e||(e=i.getLocation()),i.try(function(){var n=o.config.recommendations.id,s={story_url:e,visitor:o.config.visitor,pnespid:o.config.pnespid};return t="/onsite/recdata/id/"+n+"?"+r.param(s),i.requestAPIPromise(t)}).error(function(e){return i.loge(o.__me()+"::__getRecommendations failed for",i.stringify(t),e),[]}).then(function(e){return e=o.__parseRecommendations(e),s&&r.isArray(s)&&s.length&&(e=o.__uniqueReccomendations(e.concat(s))),[e,0]}))}).spread(function(e,t){if(o.__storeRecommendations(e),!o.config.recommendations.pagination)return o.config.recommendations.randomize&&o.__shuffleArray(e),e.slice(0,n);var r,s=e.slice(t,t+n);return s.length<n?t=(r=e.slice(0,n-s.length)).length:(r=[],t=(t+n)%e.length),i.store(o.config.id+"-recs-ls",t),o.config.recommendations.randomize&&(o.__shuffleArray(s),o.__shuffleArray(r)),o.__uniqueReccomendations(s.concat(r))})},n.prototype.__getRecommendations=i._cachedFn(function(e){return this.getRecommendations(e)}),n.prototype.__handleMessage=function(t,i){if("click"===t)return this.__click(i);e.prototype.__handleMessage.apply(this,arguments)},n.prototype.__initForm=function(){var e=this;e.__getRecommendations().then(function(t){var n=t&&t.length;if(e.__$events.emit("recsloaded",{countOfRecs:n||0}),!n)return i.log(e.__me()+": No recommendations for widget #"+e.config.id+": "+i.stringify(t)),!1;e.__sendMessage("initForm",{config:e.config,location:i.getLocation(),recommendations:t})})},n.prototype.__parseRecommendations=function(e){for(var t=[];e.length>0;){var i=e.shift()||{};t=function(e,t){for(var i=[];e.length||t.length;){if(!e.length)return i.concat(t);if(!t.length)return i.concat(e);Math.round(Math.random())?i.push(e.shift()):i.push(t.shift())}return i}(t,i&&i.stories||[])}return r.map(r.makeArray(t),function(e){return e.$d=e.$d||r.now(),e})},n.prototype.__prepareConfig=function(){if(!1===e.prototype.__prepareConfig.apply(this,arguments))return!1;var t=this.config.behavior,n=this.config.recommendations,r=this.config.view;return"width"in r?"height"in r?"placeholder_name"in t?"id"in n?"display_size"in n?void 0:(i.loge(this.__me()+"::__prepareConfig:","recommendations.display_size is not specified -",i.stringify(n)),!1):(i.loge(this.__me()+"::__prepareConfig:","recommendations.id is not specified -",i.stringify(n)),!1):(i.loge(this.__me()+"::__prepareConfig:","behavior.placeholder_name is not specified -",i.stringify(t)),!1):(i.loge(this.__me()+"::__prepareConfig:","view.height is not specified -",i.stringify(r)),!1):(i.loge(this.__me()+"::__prepareConfig:","view.width is not specified -",i.stringify(r)),!1)},n.prototype.__restoreRecommendations=function(){var e=i.restore(this.config.id+"-recs"),t=r.now()-1e3*(parseInt(this.config.recommendations.ttl_sec)||0);return r.map(r.makeArray(e),function(e){if(e.$d>t)return e})},n.prototype.__runOuterShowAnimation=function(e,t){if(!this.__attachIframeResizer())return i.reject(new Error("IframeResizer was not attached"));var n=Number(e.duration)||0;this.__$form.css("height","auto").animate({opacity:1},n,t)},n.prototype.__shuffleArray=function(e){for(var t=e.length-1;t>0;t--){var i=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[i],e[i]=n}return e},n.prototype.__storeRecommendations=function(e){return i.store(this.config.id+"-recs",e)},n.prototype.__uniqueReccomendations=function(e){if(!e||!r.isArray(e)||!e.length)return[];for(var t=[e.shift()],i=0,n=e.length;i<n;i++){for(var o=e[i],s=!0,a=0,c=t.length;s&&a<c;a++){var f=t[a];if(o===f){s=!1;break}o.title?s=o.title!==f.title:o.summary?s=o.summary!==f.summary:o.image&&(s=o.image!==f.image)}s&&t.push(o)}return t},n})}();